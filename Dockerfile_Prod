# Stage 1: Build
FROM dev-apaas-harbor-app.mis.bcs/library/golang:1.24 as builder

# 动态架构参数，默认为 ARM64
ARG TARGETARCH=arm64
ARG TARGETOS=linux

WORKDIR /build
COPY . .

# 编译并实现静态链接
RUN CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} \
    go build -ldflags="-s -w" -mod=vendor -o server main.go

# Stage 2: Final
FROM dev-apaas-harbor-app.mis.bcs/kylin_base_images/kylin-server-v10-sp1-aarch64:base
WORKDIR /app


# 1. 预先创建日志目录并授权
# 确保在切换用户前完成，解决 mkdir log permission denied 问题
RUN mkdir -p /app/log && \
    chown -R 1000:1000 /app && \
    chmod -R 755 /app

# 2. 复制文件并指定所有权
COPY --from=builder --chown=1000:1000 /build/server .
COPY --chown=1000:1000 config.yaml .

# 设置时区
ENV TZ=Asia/Shanghai

# 3. 切换到运维建议的用户
USER 1000:1000

EXPOSE 8888

# 修正了之前提到的空格/特殊字符问题
ENTRYPOINT ["/app/server"]
